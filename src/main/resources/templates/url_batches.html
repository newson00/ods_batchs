<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>URL Batches</title>
</head>
<body>
<h1>URL Batches</h1>

<form th:action="@{/url-batches}" method="get" id="searchForm">
    <label for="id1">ID1:</label>
    <input type="text" id="id1" name="id1" th:value="${id1}">

    <label for="fileName">File Name:</label>
    <input type="text" id="fileName" name="fileName" th:value="${fileName}">

    <label for="jyrq">Jyrq:</label>
    <input type="text" id="jyrq" name="jyrq" th:value="${jyrq}">

    <label for="status">Status:</label>
    <input type="text" id="status" name="status" th:value="${status}">

    <!-- 隐藏的分页大小字段 -->
    <input type="hidden" id="sizeInput" name="size" th:value="${size}">

    <button type="submit">Search</button>
    <button type="button" onclick="resetForm()">Reset Search</button>
</form>

<table border="1">
    <thead>
    <tr>
        <th>Id1</th>
        <th>Key1</th>
        <th>File URL</th>
        <th>File Name</th>
        <th>Jyrq</th>
        <th>Insert Time</th>
        <th>Update Time</th>
        <th>Status</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="urlBatch : ${urlBatchPage.content}">
        <td th:text="${urlBatch.id1}"></td>
        <td th:text="${urlBatch.key1}"></td>
        <td th:text="${urlBatch.fileUrl}"></td>
        <td th:text="${urlBatch.fileName}"></td>
        <td th:text="${urlBatch.jyrq}"></td>
        <td th:text="${urlBatch.insertTime}"></td>
        <td th:text="${urlBatch.updateTime}"></td>

        <!-- Status Column -->
        <td>
            <span th:switch="${urlBatch.status}">
                <span th:case="0">未跑批</span>
                <span th:case="1">正在跑批</span>
                <span th:case="2">跑批完成</span>
                <span th:case="*">未知状态</span>
            </span>
        </td>

        <!-- Actions Column -->
        <td>
            <button type="button" onclick="rerunBatch('${urlBatch.id1}')">重跑批</button>
        </td>
    </tr>
    </tbody>
</table>

<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
    <div>
        <a th:href="@{/url-batches(page=${urlBatchPage.number - 1}, size=${size}, id1=${id1}, fileName=${fileName}, jyrq=${jyrq}, status=${status})}"
           th:if="${urlBatchPage.hasPrevious()}">Previous</a>
        <span>Page <span th:text="${urlBatchPage.number + 1}"></span> of <span th:text="${urlBatchPage.totalPages}"></span></span>
        <a th:href="@{/url-batches(page=${urlBatchPage.number + 1}, size=${size}, id1=${id1}, fileName=${fileName}, jyrq=${jyrq}, status=${status})}"
           th:if="${urlBatchPage.hasNext()}">Next</a>
    </div>

    <div>
        <label for="size">Page Size:</label>
        <select id="size" name="size" onchange="updatePageSize(this.value)">
            <option value="10" th:selected="${size == 10}">10</option>
            <option value="20" th:selected="${size == 20}">20</option>
            <option value="50" th:selected="${size == 50}">50</option>
        </select>
    </div>
</div>

<script>
    // 当选择分页大小时更新隐藏的size字段
    function updatePageSize(size) {
        document.getElementById('sizeInput').value = size;
        document.getElementById('searchForm').submit();
    }

    // Reset form function
    function resetForm() {
        const form = document.getElementById('searchForm');
        form.reset();
        const url = new URL(window.location.href);
        const size = url.searchParams.get("size") || 10;
        url.search = "";
        url.searchParams.set("size", size);
        window.location.href = url.href;
    }

    // Rerun batch function
    function rerunBatch(id1) {
        fetch('/rerun-batch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id1: id1 })
        }).then(response => {
            if (response.ok) {
                alert('重跑批成功');
            } else {
                alert('重跑批失败');
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('重跑批时出现错误');
        });
    }
</script>

</body>
</html>
